-- Sửa URL tải script (đảm bảo đường dẫn raw chính xác)
loadstring(game:HttpGet("https://raw.githubusercontent.com/Minh-code0807/HUB/main/Help%20aotu%20farm%20bond.lua", true))()

wait(5) -- Chờ game load

-- Khai báo services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

-- Biến hệ thống
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- CẤU HÌNH NÂNG CAO
local MOVEMENT_SPEED = 1000
local SCAN_INTERVAL = 0.2
local ARRIVAL_THRESHOLD = 5
local SCAN_RADIUS = 200
local MAX_CYCLES = 5

-- Danh sách điểm đến
local WAYPOINTS = {
    Vector3.new(56.22, 3.00, 29941.12),
    Vector3.new(-428.75, 26.07, -49040.91)
}

-- Trạng thái hệ thống
local System = {
    Active = true,
    Scanning = false,
    CurrentTarget = nil,
    BondsCollected = 0,
    CurrentCycle = 1,
    GUI = nil
}

-- TẠO GUI (ĐÃ THÊM XỬ LÝ LỖI)
local function CreateEnhancedGUI()
    if System.GUI then 
        System.GUI:Destroy() 
        System.GUI = nil
    end

    local ui = Instance.new("ScreenGui")
    ui.Name = "AdvancedBondFarm"
    ui.Parent = player:WaitForChild("PlayerGui")

    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0.3, 0, 0.25, 0)
    mainFrame.Position = UDim2.new(0.02, 0, 0.7, 0)
    mainFrame.BackgroundColor3 = Color3.fromRGB(20, 25, 35)
    mainFrame.BackgroundTransparency = 0.15
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = ui

    -- Title
    local title = Instance.new("TextLabel")
    title.Text = "⚡ BOND FARMER PRO ⚡"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 18
    title.TextColor3 = Color3.new(1, 1, 1)
    title.Size = UDim2.new(1, 0, 0.15, 0)
    title.BackgroundTransparency = 1
    title.Parent = mainFrame

    -- Stats Label
    local statsLabel = Instance.new("TextLabel")
    statsLabel.Name = "StatsLabel"
    statsLabel.Text = "Loading..."
    statsLabel.Size = UDim2.new(1, 0, 0.3, 0)
    statsLabel.Position = UDim2.new(0, 0, 0.2, 0)
    statsLabel.BackgroundTransparency = 1
    statsLabel.TextColor3 = Color3.new(1, 1, 1)
    statsLabel.Parent = mainFrame

    System.GUI = ui
end

-- CẬP NHẬT GUI (HÀM BỊ THIẾU TRONG BẢN GỐC)
local function UpdateGUI()
    if System.GUI and System.GUI:FindFirstChild("StatsLabel") then
        System.GUI.StatsLabel.Text = string.format(
            "Bonds: %d | Cycle: %d/%d\nTarget: %s",
            System.BondsCollected,
            System.CurrentCycle,
            MAX_CYCLES,
            System.CurrentTarget and tostring(System.CurrentTarget.Position) or "None"
        )
    end
end

-- DI CHUYỂN THÔNG MINH (ĐÃ THÊM KIỂM TRA NIL)
local function SmartMovement(target)
    if not humanoidRootPart or not humanoid then return end
    
    humanoid.WalkSpeed = MOVEMENT_SPEED
    
    local function UpdateDirection()
        local dir = (target - humanoidRootPart.Position).Unit
        humanoidRootPart.CFrame = CFrame.lookAt(humanoidRootPart.Position, humanoidRootPart.Position + dir)
        return dir
    end

    local direction = UpdateDirection()
    humanoid:MoveTo(target)
    
    while System.Active and humanoidRootPart and humanoid do
        local distance = (humanoidRootPart.Position - target).Magnitude
        direction = UpdateDirection()
        
        if distance < ARRIVAL_THRESHOLD then
            humanoid:MoveTo(humanoidRootPart.Position)
            break
        end
        
        if not System.Scanning then
            coroutine.wrap(function()
                System.Scanning = true
                local bond = FindNearestBond()
                if bond then
                    System.CurrentTarget = bond
                    CollectBond(bond)
                end
                System.Scanning = false
            end)()
        end
        
        RunService.Heartbeat:Wait()
    end
end

-- TÌM BOND (ĐÃ MỞ RỘNG TÌM KIẾM)
local function FindNearestBond()
    local nearest = nil
    local minDistance = SCAN_RADIUS
    
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("BasePart") and (obj.Name:lower():find("bond") or obj.Parent.Name:lower():find("bond")) then
            local dist = (obj.Position - humanoidRootPart.Position).Magnitude
            if dist < minDistance then
                nearest = {
                    Part = obj,
                    Position = obj.Position,
                    Distance = dist
                }
                minDistance = dist
            end
        end
    end
    
    return nearest
end

-- THU THẬP BOND (THÊM KIỂM TRA)
local function CollectBond(bondData)
    if not bondData or not bondData.Part then return end
    
    System.CurrentTarget = bondData
    SmartMovement(bondData.Position)
    
    -- Giả lập thu thập (tuỳ chỉnh theo game)
    if bondData.Part and bondData.Part.Parent then
        bondData.Part:Destroy() -- Hoặc gọi remote event tương ứng
        System.BondsCollected += 1
        UpdateGUI()
    end
    
    System.CurrentTarget = nil
end

-- XỬ LÝ RESPAWN (THÊM MỚI)
player.CharacterAdded:Connect(function(newChar)
    character = newChar
    humanoid = newChar:WaitForChild("Humanoid")
    humanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
    CreateEnhancedGUI() -- Tạo lại GUI khi respawn
end)

-- VÒNG LẶP CHÍNH (THÊM KIỂM TRA)
local function MainLoop()
    CreateEnhancedGUI()
    
    while System.Active and System.CurrentCycle <= MAX_CYCLES do
        for _, waypoint in ipairs(WAYPOINTS) do
            if not System.Active then break end
            
            SmartMovement(waypoint)
            
            -- Quét kỹ tại điểm đến
            local bond = FindNearestBond()
            if bond then
                CollectBond(bond)
            end
            
            UpdateGUI()
            wait(SCAN_INTERVAL)
        end
        
        System.CurrentCycle += 1
    end
    
    print("Hoàn thành farm bond! Tổng cộng:", System.BondsCollected)
end

-- BẮT ĐẦU
coroutine.wrap(MainLoop)()
