local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Cấu hình
local SCAN_INTERVAL = 0.3
local TELEPORT_DELAY = 0.5
local FINAL_Y_POSITION = -15
local TELEPORT_SPEED = 100 -- Đơn vị studs/giây

-- Trạng thái hệ thống
local state = {
    gui = nil,
    textLabel = nil,
    scannedItems = {},
    isRunning = true,
    teleporting = false
}

-- Tạo GUI (ĐÃ CẢI THIỆN)
local function createGUI()
    if state.gui then state.gui:Destroy() end

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "BondScanner"
    screenGui.Parent = player:WaitForChild("PlayerGui")
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0.3, 0, 0.4, 0)
    frame.Position = UDim2.new(0.05, 0, 0.1, 0)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    frame.BackgroundTransparency = 0.3
    frame.BorderSizePixel = 0
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(0.95, 0, 0.95, 0)
    textLabel.Position = UDim2.new(0.025, 0, 0.025, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.new(1, 1, 1)
    textLabel.TextXAlignment = Enum.TextXAlignment.Left
    textLabel.TextYAlignment = Enum.TextYAlignment.Top
    textLabel.Font = Enum.Font.Code
    textLabel.TextSize = 14
    textLabel.TextStrokeTransparency = 0.7
    textLabel.Text = "Đang khởi động hệ thống quét bond...\n\nĐang quét..."
    textLabel.TextWrapped = true
    textLabel.Parent = frame
    
    frame.Parent = screenGui
    
    state.gui = screenGui
    state.textLabel = textLabel
end

-- Quét vật thể (ĐÃ CẢI THIỆN)
local function scanItems()
    local found = {}
    
    -- Kiểm tra và quét tất cả các thư mục có thể chứa bond
    local function scanFolder(folder)
        for _, item in ipairs(folder:GetDescendants()) do
            if item:IsA("BasePart") and string.find(string.lower(item.Name), "bond") then
                table.insert(found, {
                    instance = item,
                    position = item.Position,
                    name = item.Name
                })
            end
        end
    end

    -- Quét workspace và các thư mục con quan trọng
    if workspace:FindFirstChild("RuntimeItems") then
        scanFolder(workspace.RuntimeItems)
    end
    
    -- Quét thêm các vị trí khác nếu cần
    scanFolder(workspace)
    
    return found
end

-- Cập nhật GUI (ĐÃ CẢI THIỆN)
local function updateGUI()
    if not state.textLabel then return end
    
    local content = "HỆ THỐNG QUÉT BOND\n\n"
    content = content .. string.format("Trạng thái: %s\n", 
        state.teleporting and "Đang di chuyển" or "Đang quét")
    
    if #state.scannedItems == 0 then
        content = content .. "Chưa tìm thấy bond nào"
    else
        content = content .. string.format("Tìm thấy %d bond:\n", #state.scannedItems)
        for i, item in ipairs(state.scannedItems) do
            content = content .. string.format("%d. %s - X:%.1f Y:%.1f Z:%.1f\n", 
                i, item.name, item.position.X, item.position.Y, item.position.Z)
        end
    end
    
    state.textLabel.Text = content
end

-- Di chuyển mượt đến vị trí (ĐÃ CẢI THIỆN)
local function smoothTeleport(targetPos)
    if state.teleporting or not humanoidRootPart or not targetPos then return end
    state.teleporting = true
    updateGUI()
    
    local success, err = pcall(function()
        humanoidRootPart.Anchored = true
        local startPos = humanoidRootPart.Position
        local distance = (targetPos - startPos).Magnitude
        local duration = distance / TELEPORT_SPEED
        
        local tweenInfo = TweenInfo.new(
            duration,
            Enum.EasingStyle.Linear,
            Enum.EasingDirection.Out,
            0,
            false,
            0
        )
        
        local tween = TweenService:Create(humanoidRootPart, tweenInfo, {Position = targetPos})
        tween:Play()
        tween.Completed:Wait()
    end)
    
    if humanoidRootPart then
        humanoidRootPart.Anchored = false
    end
    state.teleporting = false
    updateGUI()
    
    if not success then
        warn("Lỗi khi teleport: "..tostring(err))
    end
end

-- Xử lý tự động thu thập (ĐÃ CẢI THIỆN)
local function autoCollect()
    while state.isRunning do
        if #state.scannedItems > 0 and not state.teleporting then
            local target = state.scannedItems[1]
            if target and target.instance and target.instance.Parent then
                smoothTeleport(target.position)
                task.wait(0.5) -- Chờ ổn định
                table.remove(state.scannedItems, 1)
                updateGUI()
            else
                table.remove(state.scannedItems, 1) -- Loại bỏ bond không tồn tại
            end
        end
        task.wait(TELEPORT_DELAY)
    end
end

-- Hệ thống chính (ĐÃ CẢI THIỆN)
local function startSystem()
    createGUI()
    
    -- Xử lý khi nhân vật thay đổi
    player.CharacterAdded:Connect(function(newChar)
        character = newChar
        humanoid = character:WaitForChild("Humanoid")
        humanoidRootPart = character:WaitForChild("HumanoidRootPart")
        updateGUI()
    end)
    
    -- Bắt đầu quét định kỳ
    coroutine.wrap(function()
        while state.isRunning do
            state.scannedItems = scanItems() -- Cập nhật toàn bộ danh sách
            updateGUI()
            task.wait(SCAN_INTERVAL)
        end
    end)()
    
    -- Bắt đầu tự động thu thập
    coroutine.wrap(autoCollect)()
end

-- Khởi động hệ thống
startSystem()

-- Để dừng hệ thống khi cần:
-- stopSystem()
