local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TextService = game:GetService("TextService")

-- Tối ưu hóa
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Cấu hình (đã cập nhật)
local SCAN_INTERVAL = 0.05
local TELEPORT_DELAY = 0.75
local FINAL_Y_POSITION = -15  -- Đã đổi thành -15 theo yêu cầu
local MAX_TELEPORT_DURATION = 1.5

-- Trạng thái hệ thống
local state = {
    display = nil,
    scannedItems = {},
    teleportQueue = {},
    isProcessing = false,
    scanConnection = nil,
    teleportConnection = nil
}

-- Tạo bảng hiển thị
local function createDisplay()
    local board = Instance.new("Part")
    board.Size = Vector3.new(8, 5, 0.2)
    board.Position = humanoidRootPart.Position + Vector3.new(0, 3, -4)
    board.Anchored = true
    board.CanCollide = false
    board.Transparency = 0.2
    board.Color = Color3.fromRGB(30, 30, 40)
    
    local surfaceGui = Instance.new("SurfaceGui", board)
    surfaceGui.Face = Enum.NormalId.Front
    
    local textLabel = Instance.new("TextLabel", surfaceGui)
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.new(1, 1, 1)
    textLabel.TextXAlignment = Enum.TextXAlignment.Left
    textLabel.TextYAlignment = Enum.TextYAlignment.Top
    
    board.Parent = workspace
    return textLabel
end

-- Quét vật thể
local function scanItems()
    local found = {}
    if workspace:FindFirstChild("RuntimeItems") and workspace.RuntimeItems:FindFirstChild("bond") then
        for _, item in ipairs(workspace.RuntimeItems.bond:GetChildren()) do
            if item:IsA("BasePart") then
                local roundedPos = Vector3.new(
                    math.floor(item.Position.X * 100 + 0.5) / 100,
                    math.floor(item.Position.Y * 100 + 0.5) / 100,
                    math.floor(item.Position.Z * 100 + 0.5) / 100
                )
                
                local exists = false
                for _, scanned in ipairs(state.scannedItems) do
                    if (scanned.position - roundedPos).Magnitude < 0.1 then
                        exists = true
                        break
                    end
                end
                
                if not exists then
                    table.insert(found, {
                        position = roundedPos,
                        name = item.Name
                    })
                end
            end
        end
    end
    return found
end

-- Cập nhật hiển thị
local function updateDisplay()
    local content = "QUÉT VẬT THỂ\n\n"
    for i, item in ipairs(state.scannedItems) do
        content ..= string.format("%d. %s - X:%.2f Y:%.2f Z:%.2f\n", 
            i, item.name, item.position.X, item.position.Y, item.position.Z)
    end
    state.display.Text = content
end

-- Di chuyển xuyên tường
local function teleportTo(targetPos)
    humanoidRootPart.Anchored = true
    humanoidRootPart.CanCollide = false
    
    local startPos = humanoidRootPart.Position
    local startTime = os.clock()
    local direction = (targetPos - startPos).Unit
    
    state.teleportConnection = RunService.Heartbeat:Connect(function()
        local progress = math.min((os.clock() - startTime) / MAX_TELEPORT_DURATION, 1)
        humanoidRootPart.Position = startPos + (direction * (targetPos - startPos) * progress)
        
        if progress >= 1 then
            state.teleportConnection:Disconnect()
            humanoidRootPart.Position = targetPos
        end
    end)
    
    repeat task.wait() until (humanoidRootPart.Position - targetPos).Magnitude < 2
end

-- Tải các script từ GitHub
local function loadGitHubScripts()
    state.display.Text = "Đang tải Nhặt bond..."
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Minh-code0807/HUB/refs/heads/main/Nh%E1%BA%B7t%20bond"))()
    task.wait(1)
    
    state.display.Text = "Đang tải Nhìn bond..."
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Minh-code0807/HUB/refs/heads/main/Nh%C3%ACn%20bond"))()
    task.wait(1)
    
    state.display.Text = "Đang tải FASTCASTLE..."
    loadstring(game:HttpGet("https://raw.githubusercontent.com/ringtaa/castletpfast.github.io/refs/heads/main/FASTCASTLE.lua"))()
    task.wait(5)  -- Chờ 5 giây như yêu cầu
end

-- Xử lý hàng đợi
local function processQueue()
    if state.isProcessing then return end
    state.isProcessing = true
    
    loadGitHubScripts()
    
    for _, item in ipairs(state.teleportQueue) do
        teleportTo(item.position)
        updateDisplay()
        task.wait(TELEPORT_DELAY)
    end
    
    -- Di chuyển đến Y = -15 cuối cùng
    teleportTo(Vector3.new(
        humanoidRootPart.Position.X,
        FINAL_Y_POSITION,  -- -15
        humanoidRootPart.Position.Z
    ))
    
    state.isProcessing = false
end

-- Hệ thống chính
local function startSystem()
    state.display = createDisplay()
    
    state.scanConnection = RunService.Heartbeat:Connect(function()
        local newItems = scanItems()
        if #newItems > 0 then
            for _, item in ipairs(newItems) do
                table.insert(state.scannedItems, item)
                table.insert(state.teleportQueue, item)
            end
            updateDisplay()
            
            if not state.isProcessing then
                task.spawn(processQueue)
            end
        end
    end)
end

-- Khởi động
startSystem()
